<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© - Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #0f172a; color: #f8fafc; overflow-x: hidden; }
        .bg-slate-card { background-color: #1e293b; }
        .btn-teal { background-color: #14b8a6; }
        .btn-purple { background-color: #a855f7; }
        .hidden { display: none !important; }
        .timer-bar { transition: width 0.1s linear; }
    </style>
</head>
<body class="min-h-screen flex flex-col p-4">

    <div id="app" class="max-w-md mx-auto w-full text-center py-6">
        <div class="flex justify-between items-center mb-8">
            <button onclick="goHome()" id="global-home-btn" class="hidden text-slate-400 hover:text-white text-sm">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
            <h1 class="text-3xl font-bold text-teal-400 mx-auto">Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</h1>
        </div>
        
        <div id="setup-screen" class="space-y-6">
            <div class="bg-slate-card p-6 rounded-3xl shadow-xl border border-slate-700">
                <input id="player-name-input" type="text" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ..." class="w-full p-4 rounded-xl bg-slate-800 border border-slate-600 text-center text-white mb-4">
                <button onclick="setRole('player')" class="w-full btn-teal text-white p-5 rounded-2xl text-xl font-bold">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
            </div>
            <button onclick="showHostAuth()" class="text-slate-500 text-sm underline pt-10">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø´Ø±Ù (Host)</button>
        </div>

        <div id="host-auth" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center p-6 z-50">
            <div class="bg-slate-900 p-8 rounded-3xl border border-slate-700 w-full max-w-xs">
                <input id="host-pin" type="password" placeholder="****" class="w-full p-4 rounded-xl bg-slate-800 text-center text-white mb-4">
                <button onclick="verifyHost()" class="w-full p-3 btn-purple rounded-xl font-bold">ØªØ£ÙƒÙŠØ¯</button>
            </div>
        </div>

        <div id="section-select" class="hidden space-y-4">
            <h2 class="text-xl text-slate-400">Ø§Ø®ØªØ± Ø§Ù„ÙØ¦Ø©</h2>
            <button onclick="chooseSection('adults')" class="w-full p-6 bg-slate-700 rounded-2xl font-bold border-b-4 border-slate-900">Ù‚Ø³Ù… Ø§Ù„ÙƒØ¨Ø§Ø±</button>
            <button onclick="chooseSection('children')" class="w-full p-6 bg-pink-900 rounded-2xl font-bold border-b-4 border-pink-950">Ù‚Ø³Ù… Ø§Ù„Ø£Ø·ÙØ§Ù„</button>
        </div>

        <div id="type-select" class="hidden space-y-4">
            <div class="bg-slate-800 p-4 rounded-xl flex justify-between items-center text-sm">
                <span>ØªÙØ¹ÙŠÙ„ Ù…Ø¤Ù‚Øª Ø§Ù„Ø³Ø¤Ø§Ù„ (15Ø«)</span>
                <input type="checkbox" id="timer-enabled" class="w-6 h-6 accent-teal-500">
            </div>
            <div id="brain-sub-menu" class="space-y-3"></div>
            <button id="btn-twister" onclick="setupTwisters()" class="w-full p-6 bg-orange-600 rounded-2xl font-bold shadow-lg">ØªÙ„Ø§Ø¹Ø¨ Ù„ÙØ¸ÙŠ ğŸ‘…</button>
            <button onclick="chooseType('movement')" class="w-full p-4 btn-teal rounded-2xl font-bold mt-4">ØªØ­Ø¯ÙŠ Ø§Ù„Ø­Ø±ÙƒØ©</button>
        </div>

        <div id="game-play" class="hidden">
            <div id="host-view" class="hidden space-y-4">
                <div class="flex justify-between items-center bg-slate-800 p-3 rounded-lg border border-slate-700">
                    <span id="answer-counter" class="text-teal-400 font-bold">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª...</span>
                    <button onclick="goHome()" class="text-xs text-red-400 underline">Ø¥Ù†Ù‡Ø§Ø¡</button>
                </div>
                
                <div id="timer-container" class="hidden w-full bg-slate-800 h-2 rounded-full overflow-hidden">
                    <div id="timer-progress" class="timer-bar bg-teal-400 h-full w-full"></div>
                </div>
                
                <div id="host-display" class="bg-slate-card p-8 rounded-3xl border border-slate-700 min-h-[220px] flex flex-col justify-center">
                    <div id="player-spotlight" class="hidden text-orange-400 font-bold mb-2">Ø§Ù„Ø¯ÙˆØ± Ø¹Ù„Ù‰: <span id="current-player-name">---</span></div>
                    <h2 id="display-title" class="text-2xl font-bold mb-4">...</h2>
                    <div id="display-content" class="space-y-2 text-right"></div>
                </div>

                <div id="host-controls">
                    <div id="twister-scoring" class="hidden bg-slate-800 p-4 rounded-xl mb-4 border border-orange-500">
                        <p class="text-sm mb-2 text-slate-400">Ù‚ÙŠÙ… Ø§Ù„Ø£Ø¯Ø§Ø¡ (0-10):</p>
                        <div class="grid grid-cols-5 gap-2">
                            <button onclick="awardManual(2)" class="p-2 bg-red-900 rounded">2</button>
                            <button onclick="awardManual(4)" class="p-2 bg-orange-800 rounded">4</button>
                            <button onclick="awardManual(6)" class="p-2 bg-yellow-700 rounded">6</button>
                            <button onclick="awardManual(8)" class="p-2 bg-green-700 rounded">8</button>
                            <button onclick="awardManual(10)" class="p-2 bg-green-500 rounded font-bold">10</button>
                        </div>
                    </div>
                    <button id="action-btn" onclick="triggerNext()" class="w-full btn-purple p-5 rounded-2xl font-bold text-xl shadow-lg">Ø§Ù„ØªØ§Ù„ÙŠ</button>
                    
                    <div id="post-game-controls" class="hidden space-y-3 mt-4">
                        <button onclick="restartSameCategory()" class="w-full p-5 btn-teal rounded-2xl font-bold text-xl">Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
                        <button onclick="backToGameList()" class="w-full p-4 bg-slate-700 rounded-2xl font-bold">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨</button>
                    </div>
                </div>

                <div id="leaderboard-ui" class="hidden bg-slate-900 p-4 rounded-xl border border-teal-500 mt-4">
                    <div id="leaderboard-list" class="space-y-1"></div>
                </div>
            </div>

            <div id="player-view" class="hidden space-y-4">
                <div class="bg-slate-800 p-4 rounded-xl border border-teal-900 text-center">
                    <h2 id="player-q-text" class="font-bold text-teal-200 italic">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø¶ÙŠÙ...</h2>
                </div>
                <div id="player-input-area" class="grid grid-cols-1 gap-4"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { gameData } from './questions.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, remove, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBGwNKIykgrmewdwUZyA93DQ-LHI3rLOyw",
            authDomain: "family-games-app.firebaseapp.com",
            databaseURL: "https://family-games-app-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "family-games-app",
            storageBucket: "family-games-app.firebasestorage.app",
            messagingSenderId: "290150126558",
            appId: "1:290150126558:web:bf5a38cc8d104462d9c34f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const liveRef = ref(db, 'live_game');
        const scoresRef = ref(db, 'scores');
        const answersRef = ref(db, 'current_answers');

        let myRole = ''; let myName = ''; let currentSection = ''; let currentType = ''; 
        let lastGameConfig = { section: '', type: '', poolName: '' }; // Saved for restart
        let currentQuestions = []; let currentIndex = -1;
        let playersList = []; let timerInterval = null;

        function shuffleArray(arr) {
            const newArr = [...arr];
            for (let i = newArr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArr[i], newArr[j]] = [newArr[j], newArr[i]];
            }
            return newArr;
        }

        window.goHome = () => { if(myRole === 'host') { remove(liveRef); remove(scoresRef); remove(answersRef); } location.reload(); };
        window.showHostAuth = () => document.getElementById('host-auth').classList.remove('hidden');
        window.verifyHost = () => { if(document.getElementById('host-pin').value === '1234') { document.getElementById('host-auth').classList.add('hidden'); setRole('host'); } else { alert("Ø®Ø·Ø£!"); } };

        window.setRole = (role) => {
            myRole = role;
            if (role === 'player') {
                myName = document.getElementById('player-name-input').value.trim();
                if (!myName) return alert("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ");
                set(ref(db, `scores/${myName}`), 0);
            }
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('global-home-btn').classList.remove('hidden');
            if (role === 'host') {
                remove(liveRef); remove(answersRef);
                document.getElementById('section-select').classList.remove('hidden');
                onValue(scoresRef, (snap) => { if(snap.val()) playersList = Object.keys(snap.val()); });
            } else {
                document.getElementById('game-play').classList.remove('hidden');
                document.getElementById('player-view').classList.remove('hidden');
                listenForGame();
            }
        };

        window.chooseSection = (s) => {
            currentSection = s;
            document.getElementById('section-select').classList.add('hidden');
            document.getElementById('type-select').classList.remove('hidden');
            const menu = document.getElementById('brain-sub-menu');
            menu.innerHTML = (s === 'adults') ? 
                `<button onclick="setupQuestions('culture')" class="w-full p-4 btn-purple rounded-xl font-bold mb-2">Ø«Ù‚Ø§ÙØ© Ø¹Ø§Ù…Ø©</button>
                 <button onclick="setupQuestions('islamic')" class="w-full p-4 btn-purple rounded-xl font-bold mb-2">Ø£Ø³Ø¦Ù„Ø© Ø¥Ø³Ù„Ø§Ù…ÙŠØ©</button>` :
                `<button onclick="setupQuestions('brain')" class="w-full p-4 btn-purple rounded-xl font-bold">Ø°ÙƒØ§Ø¡ Ø§Ù„Ø£Ø·ÙØ§Ù„</button>`;
        };

        window.setupQuestions = (type) => {
            lastGameConfig = { section: currentSection, type: 'brain', poolName: type };
            currentType = 'brain';
            currentIndex = -1;
            const pool = gameData[currentSection][type];
            currentQuestions = shuffleArray(pool).slice(0, 7);
            showGameUI();
        };

        window.setupTwisters = () => {
            lastGameConfig = { section: 'adults', type: 'twister', poolName: 'twisters' };
            currentType = 'twister';
            currentIndex = -1;
            const pool = gameData.adults.twisters;
            currentQuestions = shuffleArray(pool).slice(0, 5);
            showGameUI();
        };

        function showGameUI() {
            document.getElementById('leaderboard-ui').classList.add('hidden');
            document.getElementById('post-game-controls').classList.add('hidden');
            document.getElementById('action-btn').classList.remove('hidden');
            document.getElementById('type-select').classList.add('hidden');
            document.getElementById('game-play').classList.remove('hidden');
            document.getElementById('host-view').classList.remove('hidden');
            document.getElementById('display-content').innerHTML = "Ø§Ø³ØªØ¹Ø¯ÙˆØ§...";
            document.getElementById('display-title').innerText = "Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©";
        }

        // RESTART LOGIC
        window.restartSameCategory = () => {
            // Reset scores in Firebase
            playersList.forEach(p => set(ref(db, `scores/${p}`), 0));
            if(lastGameConfig.type === 'brain') setupQuestions(lastGameConfig.poolName);
            else setupTwisters();
        };

        window.backToGameList = () => {
            playersList.forEach(p => set(ref(db, `scores/${p}`), 0));
            remove(liveRef);
            document.getElementById('host-view').classList.add('hidden');
            document.getElementById('type-select').classList.remove('hidden');
        };

        window.triggerNext = () => {
            currentIndex++;
            clearInterval(timerInterval);
            remove(answersRef);
            
            if (currentIndex < currentQuestions.length) {
                const item = currentQuestions[currentIndex];
                let pSpot = "Ø§Ù„Ø¬Ù…ÙŠØ¹";
                if (currentType === 'twister') {
                    pSpot = playersList[currentIndex % playersList.length] || "Ø§Ù„Ù…ØªØ·ÙˆØ¹";
                    document.getElementById('player-spotlight').classList.remove('hidden');
                    document.getElementById('current-player-name').innerText = pSpot;
                    document.getElementById('twister-scoring').classList.add('hidden');
                } else {
                    document.getElementById('player-spotlight').classList.add('hidden');
                    listenForAnswers();
                }
                set(liveRef, { type: currentType, content: item, startTime: Date.now(), status: 'playing', activePlayer: pSpot });
                renderHost(item);
                if (document.getElementById('timer-enabled').checked) startTimer(15);
            } else { announceWinner(); }
        };

        function listenForAnswers() {
            onValue(answersRef, (snap) => {
                const count = snap.val() ? Object.keys(snap.val()).length : 0;
                document.getElementById('answer-counter').innerText = `Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª: ${count} / ${playersList.length}`;
            });
        }

        function startTimer(sec) {
            const container = document.getElementById('timer-container');
            const bar = document.getElementById('timer-progress');
            container.classList.remove('hidden');
            let w = 100;
            timerInterval = setInterval(() => {
                w -= (100 / (sec * 10));
                bar.style.width = w + "%";
                if (w <= 0) {
                    clearInterval(timerInterval);
                    if(currentType === 'twister') document.getElementById('twister-scoring').classList.remove('hidden');
                    set(ref(db, 'live_game/status'), 'timeup');
                }
            }, 100);
        }

        window.awardManual = (pts) => {
            const name = document.getElementById('current-player-name').innerText;
            get(ref(db, `scores/${name}`)).then(s => set(ref(db, `scores/${name}`), (s.val() || 0) + pts));
            document.getElementById('twister-scoring').classList.add('hidden');
            alert(`ØªÙ… Ù…Ù†Ø­ ${pts} Ù†Ù‚Ø§Ø· Ù„Ù€ ${name}`);
        };

        function renderHost(item) {
            const title = document.getElementById('display-title');
            const content = document.getElementById('display-content');
            if (currentType === 'brain') {
                title.innerText = item.q;
                content.innerHTML = item.options.map(o => `<div class='p-3 bg-slate-800 rounded-lg'>${o}</div>`).join('');
            } else {
                title.innerText = "ÙƒØ±Ø± Ø§Ù„Ø¬Ù…Ù„Ø© 5 Ù…Ø±Ø§Øª Ø¨Ø³Ø±Ø¹Ø©:";
                content.innerHTML = `<p class='text-3xl text-teal-400 font-bold text-center'>${item}</p>`;
            }
            document.getElementById('action-btn').innerText = "Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©";
        }

        async function announceWinner() {
            const snap = await get(scoresRef);
            const scores = snap.val() || {};
            const sorted = Object.entries(scores).sort((a,b) => b[1]-a[1]);
            set(liveRef, { status: 'finished', winner: sorted[0] ? sorted[0][0] : "---" });
            
            document.getElementById('display-title').innerText = "ğŸ† Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ğŸ†";
            document.getElementById('display-content').innerHTML = `<h1 class='text-4xl text-yellow-400'>Ø§Ù„ÙØ§Ø¦Ø²: ${sorted[0] ? sorted[0][0] : "---"}</h1>`;
            document.getElementById('leaderboard-list').innerHTML = sorted.map(([n,v]) => `<div class='flex justify-between p-2 bg-slate-800 mb-1 rounded'><span>${n}</span><span>${Math.round(v)}</span></div>`).join('');
            
            document.getElementById('leaderboard-ui').classList.remove('hidden');
            document.getElementById('action-btn').classList.add('hidden');
            document.getElementById('post-game-controls').classList.remove('hidden');
            confetti({ particleCount: 200, spread: 70, origin: { y: 0.6 } });
        }

        function listenForGame() {
            onValue(liveRef, (snap) => {
                const data = snap.val(); if(!data) return;
                const area = document.getElementById('player-input-area');
                if(data.status === 'timeup') {
                    area.innerHTML = "<p class='text-red-500 font-bold text-center text-xl'>Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª!</p>";
                    return;
                }
                if(data.type === 'twister') {
                    document.getElementById('player-q-text').innerText = (data.activePlayer === myName) ? "Ø¯ÙˆØ±Ùƒ Ø§Ù„Ø¢Ù†! Ø§Ø³ØªØ¹Ø¯" : `Ø§Ù„Ø¯ÙˆØ± Ø¹Ù„Ù‰: ${data.activePlayer}`;
                    area.innerHTML = (data.activePlayer === myName) ? `<div class='p-6 bg-orange-600 rounded-2xl text-2xl font-bold text-center'>${data.content}</div>` : "<p class='text-slate-500 text-center'>Ø§Ø³ØªÙ…Ø¹ Ø¨ØªØ±ÙƒÙŠØ²...</p>";
                } else if (data.type === 'brain') {
                    document.getElementById('player-q-text').innerText = data.content.q;
                    area.innerHTML = data.content.options.map((o, i) => `<button onclick="submitAnswer(${i}, ${data.content.correct}, ${data.startTime})" class="p-4 btn-teal rounded-xl font-bold shadow-md active:scale-95">${o}</button>`).join('');
                }
            });
        }

        window.submitAnswer = (idx, correct, start) => {
            set(ref(db, `current_answers/${myName}`), true);
            if(idx === correct) {
                const speed = (Date.now() - start) / 1000;
                const points = 10 + Math.max(0, 10 - speed);
                get(ref(db, `scores/${myName}`)).then(s => set(ref(db, `scores/${myName}`), (s.val() || 0) + points));
            }
            document.getElementById('player-input-area').innerHTML = "<p class='text-teal-400 text-center font-bold'>ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„!</p>";
        };
    </script>
</body>
</html>
