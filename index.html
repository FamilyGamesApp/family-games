<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© - Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #0f172a; color: #f8fafc; overflow-x: hidden; }
        .bg-slate-card { background-color: #1e293b; }
        .btn-teal { background-color: #14b8a6; }
        .btn-purple { background-color: #a855f7; }
        .hidden { display: none !important; }
        .timer-bar { transition: width 0.1s linear; }
    </style>
</head>
<body class="min-h-screen flex flex-col p-4">

    <div id="app" class="max-w-md mx-auto w-full text-center py-6">
        <div class="flex justify-between items-center mb-8">
            <button onclick="goHome()" id="global-home-btn" class="hidden text-slate-400 hover:text-white text-sm">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
            <h1 class="text-3xl font-bold text-teal-400 mx-auto">Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</h1>
        </div>
        
        <div id="setup-screen" class="space-y-6">
            <div class="bg-slate-card p-6 rounded-3xl shadow-xl border border-slate-700">
                <input id="player-name-input" type="text" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ..." class="w-full p-4 rounded-xl bg-slate-800 border border-slate-600 text-center text-white mb-4">
                <button onclick="setRole('player')" class="w-full btn-teal text-white p-5 rounded-2xl text-xl font-bold">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
            </div>
            <button onclick="showHostAuth()" class="text-slate-500 text-sm underline pt-10">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø´Ø±Ù (Host)</button>
        </div>

        <div id="host-auth" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center p-6 z-50">
            <div class="bg-slate-900 p-8 rounded-3xl border border-slate-700 w-full max-w-xs">
                <input id="host-pin" type="password" placeholder="Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„" class="w-full p-4 rounded-xl bg-slate-800 text-center text-white mb-4">
                <button onclick="verifyHost()" class="w-full p-3 btn-purple rounded-xl font-bold">ØªØ£ÙƒÙŠØ¯</button>
            </div>
        </div>

        <div id="section-select" class="hidden space-y-4">
            <h2 class="text-xl text-slate-400 mb-4">Ø§Ø®ØªØ± Ø§Ù„ÙØ¦Ø©</h2>
            <button onclick="chooseSection('adults')" class="w-full p-6 bg-slate-700 rounded-2xl font-bold">Ù‚Ø³Ù… Ø§Ù„ÙƒØ¨Ø§Ø±</button>
            <button onclick="chooseSection('children')" class="w-full p-6 bg-pink-900 rounded-2xl font-bold">Ù‚Ø³Ù… Ø§Ù„Ø£Ø·ÙØ§Ù„</button>
        </div>

        <div id="type-select" class="hidden space-y-4">
            <div id="timer-toggle-area" class="bg-slate-800 p-4 rounded-xl mb-4 flex justify-between items-center">
                <span>ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆÙ‚Øª (15 Ø«Ø§Ù†ÙŠØ©)</span>
                <input type="checkbox" id="timer-enabled" class="w-6 h-6">
            </div>
            <div id="brain-sub-menu" class="space-y-3"></div>
            <div id="twister-menu" class="mt-4">
                <button onclick="setupTwisters()" class="w-full p-6 bg-orange-600 rounded-2xl font-bold">Ù„Ø¹Ø¨Ø© Ø­Ø¨Ø³ Ø§Ù„Ù„Ø³Ø§Ù† ğŸ‘…</button>
            </div>
            <button onclick="chooseType('movement')" class="w-full p-4 btn-teal rounded-2xl font-bold mt-4">ØªØ­Ø¯ÙŠ Ø§Ù„Ø­Ø±ÙƒØ©</button>
        </div>

        <div id="game-play" class="hidden">
            <div id="host-view" class="hidden space-y-4">
                <div id="timer-container" class="hidden w-full bg-slate-800 h-2 rounded-full overflow-hidden">
                    <div id="timer-progress" class="timer-bar bg-teal-400 h-full w-full"></div>
                </div>
                
                <div id="host-display" class="bg-slate-card p-8 rounded-3xl border border-slate-700 min-h-[200px] flex flex-col justify-center">
                    <div id="player-spotlight" class="hidden text-orange-400 font-bold mb-2">Ø¯ÙˆØ± Ø§Ù„Ù„Ø§Ø¹Ø¨: <span id="current-player-name">---</span></div>
                    <h2 id="display-title" class="text-3xl font-bold mb-4">...</h2>
                    <div id="display-content"></div>
                </div>

                <div id="host-controls" class="space-y-2">
                    <div id="twister-scoring" class="hidden grid grid-cols-5 gap-1 bg-slate-800 p-2 rounded-xl">
                        <button onclick="awardManual(2)" class="p-2 bg-red-900 rounded">2</button>
                        <button onclick="awardManual(4)" class="p-2 bg-orange-900 rounded">4</button>
                        <button onclick="awardManual(6)" class="p-2 bg-yellow-900 rounded">6</button>
                        <button onclick="awardManual(8)" class="p-2 bg-green-800 rounded">8</button>
                        <button onclick="awardManual(10)" class="p-2 bg-green-600 rounded">10</button>
                    </div>
                    <button id="action-btn" onclick="triggerNext()" class="w-full btn-purple p-5 rounded-2xl font-bold text-xl shadow-lg">Ø§Ù„ØªØ§Ù„ÙŠ</button>
                </div>

                <div id="leaderboard-ui" class="hidden bg-slate-900 p-4 rounded-xl border border-teal-500 mt-4">
                    <div id="leaderboard-list" class="space-y-1"></div>
                </div>
            </div>

            <div id="player-view" class="hidden space-y-4">
                <div class="bg-slate-800 p-4 rounded-xl border border-teal-900">
                    <h2 id="player-q-text" class="font-bold text-teal-200 italic">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø¶ÙŠÙ...</h2>
                </div>
                <div id="player-input-area" class="grid grid-cols-1 gap-4"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { gameData } from './questions.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, remove, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // CONFIG (Ensure this matches your Firebase)
        const firebaseConfig = {
            apiKey: "AIzaSyBGwNKIykgrmewdwUZyA93DQ-LHI3rLOyw",
            authDomain: "family-games-app.firebaseapp.com",
            databaseURL: "https://family-games-app-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "family-games-app",
            storageBucket: "family-games-app.firebasestorage.app",
            messagingSenderId: "290150126558",
            appId: "1:290150126558:web:bf5a38cc8d104462d9c34f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const liveRef = ref(db, 'live_game');
        const scoresRef = ref(db, 'scores');
        const answersRef = ref(db, 'current_answers');

        let myRole = ''; let myName = ''; let currentSection = ''; let currentType = ''; 
        let currentQuestions = []; let currentIndex = -1;
        let playersList = []; let timerInterval = null;

        // --- NAVIGATION ---
        window.goHome = () => { if(myRole === 'host') { remove(liveRef); remove(scoresRef); remove(answersRef); } location.reload(); };

        // --- HOST AUTH ---
        window.showHostAuth = () => document.getElementById('host-auth').classList.remove('hidden');
        window.verifyHost = () => { if(document.getElementById('host-pin').value === '1234') { document.getElementById('host-auth').classList.add('hidden'); setRole('host'); } else { alert("Ø±Ù…Ø² Ø®Ø§Ø·Ø¦!"); } };

        window.setRole = (role) => {
            myRole = role;
            if (role === 'player') {
                myName = document.getElementById('player-name-input').value.trim();
                if (!myName) return alert("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ");
            }
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('global-home-btn').classList.remove('hidden');
            if (role === 'host') {
                remove(scoresRef);
                document.getElementById('section-select').classList.remove('hidden');
                // Track players for Twister randomization
                onValue(scoresRef, (snap) => { if(snap.val()) playersList = Object.keys(snap.val()); });
            } else {
                document.getElementById('game-play').classList.remove('hidden');
                document.getElementById('player-view').classList.remove('hidden');
                set(ref(db, `scores/${myName}`), 0); // Register player
                listenForGame();
            }
        };

        window.chooseSection = (s) => {
            currentSection = s;
            document.getElementById('section-select').classList.add('hidden');
            document.getElementById('type-select').classList.remove('hidden');
            const brainMenu = document.getElementById('brain-sub-menu');
            brainMenu.innerHTML = (s === 'adults') ? 
                `<button onclick="setupQuestions('culture')" class="w-full p-4 btn-purple rounded-xl font-bold mb-2">Ø«Ù‚Ø§ÙØ© Ø¹Ø§Ù…Ø©</button>
                 <button onclick="setupQuestions('islamic')" class="w-full p-4 btn-purple rounded-xl font-bold mb-2">Ø£Ø³Ø¦Ù„Ø© Ø¥Ø³Ù„Ø§Ù…ÙŠØ©</button>` :
                `<button onclick="setupQuestions('brain')" class="w-full p-4 btn-purple rounded-xl font-bold">Ø°ÙƒØ§Ø¡ Ø§Ù„Ø£Ø·ÙØ§Ù„</button>`;
        };

        window.setupQuestions = (type) => {
            currentType = 'brain';
            currentQuestions = gameData[currentSection][type].sort(() => 0.5 - Math.random()).slice(0, 7);
            startHostUI();
        };

        window.setupTwisters = () => {
            currentType = 'twister';
            currentQuestions = gameData.adults.twisters.sort(() => 0.5 - Math.random()).slice(0, 5);
            startHostUI();
        };

        function startHostUI() {
            document.getElementById('type-select').classList.add('hidden');
            document.getElementById('game-play').classList.remove('hidden');
            document.getElementById('host-view').classList.remove('hidden');
        }

        // --- CORE LOGIC ---
        window.triggerNext = () => {
            currentIndex++;
            clearInterval(timerInterval);
            remove(answersRef);
            
            if (currentIndex < currentQuestions.length) {
                const item = currentQuestions[currentIndex];
                let randomPlayer = "Ø§Ù„Ø¬Ù…ÙŠØ¹";
                
                if (currentType === 'twister') {
                    randomPlayer = playersList[Math.floor(Math.random() * playersList.length)] || "Ø§Ù„Ù…ØªØ·ÙˆØ¹";
                    document.getElementById('player-spotlight').classList.remove('hidden');
                    document.getElementById('current-player-name').innerText = randomPlayer;
                    document.getElementById('twister-scoring').classList.add('hidden'); // Hide until timer ends
                }

                set(liveRef, { 
                    type: currentType, content: item, startTime: Date.now(), 
                    status: 'playing', activePlayer: randomPlayer 
                });
                
                renderHost(item);
                if (document.getElementById('timer-enabled').checked) startTimer(15);
            } else { announceWinner(); }
        };

        function startTimer(seconds) {
            const bar = document.getElementById('timer-progress');
            const container = document.getElementById('timer-container');
            container.classList.remove('hidden');
            let width = 100;
            const dec = 100 / (seconds * 10);
            
            timerInterval = setInterval(() => {
                width -= dec;
                bar.style.width = width + "%";
                if (width <= 0) {
                    clearInterval(timerInterval);
                    if(currentType === 'twister') document.getElementById('twister-scoring').classList.remove('hidden');
                    set(ref(db, 'live_game/status'), 'timeup');
                }
            }, 100);
        }

        window.awardManual = (pts) => {
            const pName = document.getElementById('current-player-name').innerText;
            const pRef = ref(db, `scores/${pName}`);
            get(pRef).then(s => set(pRef, (s.val() || 0) + pts));
            document.getElementById('twister-scoring').classList.add('hidden');
            alert(`ØªÙ… Ø¥Ø¶Ø§ÙØ© ${pts} Ù†Ù‚Ø§Ø· Ù„Ù€ ${pName}`);
        };

        function renderHost(item) {
            const title = document.getElementById('display-title');
            const content = document.getElementById('display-content');
            if (currentType === 'brain') {
                title.innerText = item.q;
                content.innerHTML = item.options.map(o => `<div class='p-3 bg-slate-800 rounded-lg mb-2'>${o}</div>`).join('');
            } else if (currentType === 'twister') {
                title.innerText = "Ù‚Ù„Ù‡Ø§ 5 Ù…Ø±Ø§Øª Ø¨Ø³Ø±Ø¹Ø©:";
                content.innerHTML = `<p class='text-4xl text-teal-400 font-bold'>${item}</p>`;
            }
        }

        async function announceWinner() {
            const snap = await get(scoresRef);
            const scores = snap.val() || {};
            const sorted = Object.entries(scores).sort((a,b) => b[1]-a[1]);
            set(liveRef, { status: 'finished', winner: sorted[0] ? sorted[0][0] : "---" });
            
            document.getElementById('display-title').innerText = "ğŸ† Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ğŸ†";
            document.getElementById('display-content').innerHTML = `<h1 class='text-4xl text-yellow-400'>Ø§Ù„ÙØ§Ø¦Ø²: ${sorted[0][0]}</h1>`;
            document.getElementById('leaderboard-list').innerHTML = sorted.map(([n, v]) => `<div class='flex justify-between p-2 bg-slate-800 mb-1'><span>${n}</span><span>${Math.round(v)}</span></div>`).join('');
            document.getElementById('leaderboard-ui').classList.remove('hidden');
            document.getElementById('action-btn').classList.add('hidden');
            confetti({ particleCount: 150 });
        }

        function listenForGame() {
            onValue(liveRef, (snap) => {
                const data = snap.val(); if(!data) return;
                const area = document.getElementById('player-input-area');
                
                if(data.status === 'timeup') {
                    area.innerHTML = "<p class='text-red-500 font-bold text-center'>Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª!</p>";
                    return;
                }

                if(data.type === 'twister') {
                    document.getElementById('player-q-text').innerText = (data.activePlayer === myName) ? "Ø¯ÙˆØ±Ùƒ Ø§Ù„Ø¢Ù†! Ø§Ø³ØªØ¹Ø¯ Ù„Ù„ÙƒÙ„Ø§Ù…" : `Ø¯ÙˆØ± Ø§Ù„Ù„Ø§Ø¹Ø¨: ${data.activePlayer}`;
                    area.innerHTML = (data.activePlayer === myName) ? `<div class='p-6 bg-orange-600 rounded-2xl text-2xl font-bold'>${data.content}</div>` : "<p class='text-slate-500'>Ø§Ø³ØªÙ…Ø¹ Ø¨ØªØ±ÙƒÙŠØ²...</p>";
                } else if (data.type === 'brain') {
                    document.getElementById('player-q-text').innerText = data.content.q;
                    area.innerHTML = data.content.options.map((o, i) => `<button onclick="submitAnswer(${i}, ${data.content.correct}, ${data.startTime})" class="p-4 btn-teal rounded-xl font-bold">${o}</button>`).join('');
                }
            });
        }

        window.submitAnswer = (idx, correct, start) => {
            if(idx === correct) {
                const speed = (Date.now() - start) / 1000;
                const points = 10 + Math.max(0, 10 - speed);
                const pRef = ref(db, `scores/${myName}`);
                get(pRef).then(s => set(pRef, (s.val() || 0) + points));
            }
            document.getElementById('player-input-area').innerHTML = "<p class='text-teal-400'>ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„!</p>";
        };
    </script>
</body>
</html>
