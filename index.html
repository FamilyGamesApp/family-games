<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…ØªØ·ÙˆØ±Ø©</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #0f172a; color: #f8fafc; }
        .bg-slate-card { background-color: #1e293b; }
        .btn-teal { background-color: #14b8a6; }
        .btn-purple { background-color: #a855f7; }
        .winner-anim { animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    </style>
</head>
<body class="min-h-screen flex flex-col p-4">

    <div id="app" class="max-w-md mx-auto w-full text-center py-6">
        <h1 class="text-4xl font-bold mb-8 text-teal-400">Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</h1>
        
        <div id="setup-screen" class="space-y-6">
            <button onclick="setRole('host')" class="w-full btn-teal text-white p-6 rounded-2xl text-2xl font-bold shadow-lg">Ø£Ù†Ø§ Ø´Ø§Ø´Ø© Ø§Ù„Ø¹Ø±Ø¶ (Host)</button>
            <div class="space-y-2">
                <input id="player-name-input" type="text" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ..." class="w-full p-4 rounded-xl bg-slate-800 border border-slate-600 text-center text-white">
                <button onclick="setRole('player')" class="w-full bg-slate-card text-white p-6 rounded-2xl text-2xl font-bold border border-slate-700">Ø£Ù†Ø§ Ù„Ø§Ø¹Ø¨ (Ø¬ÙˆØ§Ù„)</button>
            </div>
        </div>

        <div id="section-select" class="hidden space-y-4">
            <h2 class="text-2xl font-bold mb-6 text-slate-400">Ø§Ø®ØªØ± Ø§Ù„ÙØ¦Ø©</h2>
            <button onclick="chooseSection('adults')" class="w-full p-6 bg-slate-700 rounded-xl text-xl font-bold">Ù‚Ø³Ù… Ø§Ù„ÙƒØ¨Ø§Ø±</button>
            <button onclick="chooseSection('children')" class="w-full p-6 bg-pink-900 rounded-xl text-xl font-bold">Ù‚Ø³Ù… Ø§Ù„Ø£Ø·ÙØ§Ù„</button>
        </div>

        <div id="type-select" class="hidden space-y-4 text-right">
            <h2 class="text-2xl font-bold mb-6 text-center text-slate-400">Ø§Ø®ØªØ± Ø§Ù„Ù„Ø¹Ø¨Ø©</h2>
            
            <div class="text-teal-400 font-bold mb-2">Ø£Ù„Ø¹Ø§Ø¨ Ø°Ù‡Ù†ÙŠØ©:</div>
            <button onclick="chooseType('brain')" class="w-full p-4 btn-purple rounded-xl font-bold mb-2">Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ø«Ù‚Ø§ÙÙŠØ© (Ù…ØªÙˆÙØ±Ø©)</button>
            <button class="w-full p-4 bg-slate-800 text-slate-500 rounded-xl font-bold mb-4 cursor-not-allowed border border-dashed border-slate-600" disabled>Ù„Ø¹Ø¨Ø© Ù„ØºØ² Ø§Ù„ÙƒÙ„Ù…Ø§Øª (Ù‚Ø±ÙŠØ¨Ø§Ù‹)</button>

            <div class="text-purple-400 font-bold mb-2">Ø£Ù„Ø¹Ø§Ø¨ Ø­Ø±ÙƒÙŠØ©:</div>
            <button onclick="chooseType('movement')" class="w-full p-4 btn-teal rounded-xl font-bold mb-2">ØªØ­Ø¯ÙŠ Ø§Ù„Ø­Ø±ÙƒØ© (Ù…ØªÙˆÙØ±Ø©)</button>
            <button class="w-full p-4 bg-slate-800 text-slate-500 rounded-xl font-bold cursor-not-allowed border border-dashed border-slate-600" disabled>ØªØ­Ø¯ÙŠ Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ (Ù‚Ø±ÙŠØ¨Ø§Ù‹)</button>
        </div>

        <div id="game-play" class="hidden">
            <div id="host-view" class="hidden space-y-4 text-right">
                <div class="flex justify-between items-center bg-slate-800 p-3 rounded-lg border border-slate-700">
                    <span id="answer-counter" class="text-teal-400 font-bold">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©: 0</span>
                </div>

                <div id="host-display" class="bg-slate-card p-6 rounded-2xl border border-slate-700">
                    <h2 id="display-title" class="text-2xl font-bold mb-4 text-teal-300 text-center">...</h2>
                    <div id="display-content" class="text-lg space-y-2"></div>
                </div>
                
                <div id="leaderboard-ui" class="hidden bg-slate-900 p-4 rounded-xl border border-teal-500">
                    <h3 class="text-lg font-bold text-teal-400 mb-2 border-b border-slate-800 pb-1 text-center font-bold">Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</h3>
                    <div id="leaderboard-list" class="space-y-1"></div>
                </div>

                <div class="flex flex-col gap-3">
                    <button id="action-btn" onclick="triggerNext()" class="w-full btn-purple p-4 rounded-xl font-bold">Ø§Ø¨Ø¯Ø£</button>
                    <button onclick="location.reload()" class="text-xs text-slate-600 text-center">Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØ§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
                </div>
            </div>

            <div id="player-view" class="hidden space-y-4">
                <div id="player-header" class="bg-slate-800 p-4 rounded-xl border border-teal-900">
                    <h2 id="player-q-text" class="font-bold text-lg text-teal-200 italic">Ø§Ù†ØªØ¸Ø± Ø§Ù„Ù…Ø¶ÙŠÙ...</h2>
                </div>
                <div id="player-input-area" class="grid grid-cols-1 gap-4"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, remove, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBGwNKIykgrmewdwUZyA93DQ-LHI3rLOyw",
            authDomain: "family-games-app.firebaseapp.com",
            databaseURL: "https://family-games-app-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "family-games-app",
            storageBucket: "family-games-app.firebasestorage.app",
            messagingSenderId: "290150126558",
            appId: "1:290150126558:web:bf5a38cc8d104462d9c34f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const liveRef = ref(db, 'live_game');
        const scoresRef = ref(db, 'scores');
        const answersRef = ref(db, 'current_answers');

        const gameData = {
            adults: {
                brain: [
                    { q: "Ù…Ø§ Ù‡Ùˆ Ø£Ø·ÙˆÙ„ Ù†Ù‡Ø± ÙÙŠ Ø§Ù„Ø¹Ø§Ù„Ù…ØŸ", options: ["Ø§Ù„Ø£Ù…Ø§Ø²ÙˆÙ†", "Ø§Ù„Ù†ÙŠÙ„", "Ø§Ù„Ù…ÙŠØ³ÙŠØ³ÙŠØ¨ÙŠ"], correct: 1 },
                    { q: "ÙÙŠ Ø£ÙŠ Ù…Ø¯ÙŠÙ†Ø© ÙŠÙ‚Ø¹ Ø¨Ø±Ø¬ Ø¥ÙŠÙÙ„ØŸ", options: ["Ù„Ù†Ø¯Ù†", "Ø¨Ø§Ø±ÙŠØ³", "Ø¨Ø±Ù„ÙŠÙ†"], correct: 1 }
                ],
                movement: ["Ù‚Ù… Ø¨ØªÙ…Ø«ÙŠÙ„ Ø¯ÙˆØ± 'Ø´ÙŠÙ' ÙŠØ·Ø¨Ø® Ø£ÙƒÙ„Ø© ØºØ±ÙŠØ¨Ø©", "Ø­Ø§ÙˆÙ„ Ù„Ù…Ø³ Ø£Ù†ÙÙƒ Ø¨Ù„Ø³Ø§Ù†Ùƒ"]
            },
            children: {
                brain: [
                    { q: "ÙƒÙ… Ø¹Ø¯Ø¯ Ø£Ù„ÙˆØ§Ù† Ù‚ÙˆØ³ Ù‚Ø²Ø­ØŸ", options: ["5", "7", "9"], correct: 1 },
                    { q: "Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ø§Ù„Ø°ÙŠ ÙŠØ¹ÙŠØ´ ÙÙŠ Ø§Ù„Ø¨Ø­Ø± ÙˆÙ„Ù‡ 8 Ø£Ø±Ø¬Ù„ØŸ", options: ["Ø§Ù„Ø³Ù…ÙƒØ©", "Ø§Ù„Ø£Ø®Ø·Ø¨ÙˆØ·", "Ø§Ù„Ø³Ø±Ø·Ø§Ù†"], correct: 1 }
                ],
                movement: ["Ø§Ù‚ÙØ² Ù…Ø«Ù„ Ø§Ù„ÙƒÙ†ØºØ±", "Ù‚Ù„Ø¯ ØµÙˆØª Ø§Ù„Ø£Ø³Ø¯ Ø¨Ù‚ÙˆØ©"]
            }
        };

        let myRole = ''; let myName = ''; let currentSection = ''; let currentType = ''; let currentIndex = -1;
        let questionStartTime = 0;

        window.setRole = (role) => {
            myRole = role;
            if (role === 'player') {
                myName = document.getElementById('player-name-input').value.trim();
                if (!myName) return alert("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ");
            }
            document.getElementById('setup-screen').classList.add('hidden');
            if (role === 'host') {
                remove(scoresRef);
                document.getElementById('section-select').classList.remove('hidden');
            } else {
                document.getElementById('game-play').classList.remove('hidden');
                document.getElementById('player-view').classList.remove('hidden');
                listenForGame();
            }
        };

        window.chooseSection = (s) => { currentSection = s; document.getElementById('section-select').classList.add('hidden'); document.getElementById('type-select').classList.remove('hidden'); };
        window.chooseType = (t) => { currentType = t; document.getElementById('type-select').classList.add('hidden'); document.getElementById('game-play').classList.remove('hidden'); document.getElementById('host-view').classList.remove('hidden'); };

        window.triggerNext = () => {
            currentIndex++;
            const dataSet = gameData[currentSection][currentType];
            remove(answersRef);
            
            if (currentIndex < dataSet.length) {
                const item = dataSet[currentIndex];
                set(liveRef, { 
                    type: currentType, 
                    content: item, 
                    startTime: Date.now(), 
                    status: 'playing' 
                });
                renderHost(item);
                listenForAnswers();
            } else {
                announceWinner();
            }
        };

        function renderHost(item) {
            document.getElementById('display-title').innerText = (currentType === 'brain') ? item.q : "ØªØ­Ø¯ÙŠ Ø§Ù„Ø­Ø±ÙƒØ©";
            document.getElementById('display-content').innerHTML = (currentType === 'brain') ? item.options.map(opt => `<div class='p-3 bg-slate-800 rounded-lg border border-slate-700'>${opt}</div>`).join('') : `<p class='text-2xl text-teal-400 text-center font-bold'>${item}</p>`;
            document.getElementById('action-btn').innerText = "Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ";
        }

        function listenForAnswers() {
            onValue(answersRef, (snap) => {
                const count = snap.val() ? Object.keys(snap.val()).length : 0;
                document.getElementById('answer-counter').innerText = `Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©: ${count}`;
            });
        }

        async function announceWinner() {
            const snap = await get(scoresRef);
            const scores = snap.val() || {};
            const sorted = Object.entries(scores).sort((a,b) => b[1]-a[1]);
            const winnerName = sorted.length > 0 ? sorted[0][0] : "Ø§Ù„Ø¬Ù…ÙŠØ¹";
            
            set(liveRef, { status: 'finished', winner: winnerName });
            
            document.getElementById('display-title').innerText = "ğŸ† Ø§Ù„ÙØ§Ø¦Ø² Ù‡Ùˆ ğŸ†";
            document.getElementById('display-content').innerHTML = `<h1 class="text-5xl font-bold text-yellow-400 winner-anim text-center">${winnerName}</h1>`;
            
            const list = document.getElementById('leaderboard-list');
            list.innerHTML = sorted.map(([name, val]) => `<div class="flex justify-between p-2 bg-slate-800 mb-1 rounded"><span>${name}</span><span class="text-teal-400 font-bold">${Math.round(val)} Ù†Ù‚Ø·Ø©</span></div>`).join('');
            document.getElementById('leaderboard-ui').classList.remove('hidden');
            document.getElementById('action-btn').classList.add('hidden');
            
            confetti({ particleCount: 200, spread: 80, origin: { y: 0.6 } });
        }

        function listenForGame() {
            onValue(liveRef, (snap) => {
                const data = snap.val(); if (!data) return;
                const area = document.getElementById('player-input-area');
                if (data.status === 'finished') {
                    area.innerHTML = (data.winner === myName) ? "<h1 class='text-3xl text-yellow-400 font-bold winner-anim'>Ù„Ù‚Ø¯ ÙØ²Øª! ğŸ†</h1>" : `<p class='text-slate-400'>Ø§Ù„ÙØ§Ø¦Ø² Ù‡Ùˆ: ${data.winner}</p>`;
                    return;
                }
                document.getElementById('player-q-text').innerText = (data.type === 'brain') ? data.content.q : "Ø§ØªØ¨Ø¹ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ù…Ø¶ÙŠÙ!";
                if (data.type === 'brain') {
                    area.innerHTML = data.content.options.map((opt, i) => `<button onclick="submitAnswer(${i}, ${data.content.correct}, ${data.startTime})" class="p-4 btn-teal rounded-xl font-bold active:scale-95 transition-all">${opt}</button>`).join('');
                } else { area.innerHTML = "<p class='text-teal-400 text-center font-bold'>Ø§Ø³ØªØ¹Ø¯!</p>"; }
            });
        }

        window.submitAnswer = (idx, correct, startTime) => {
            set(ref(db, `current_answers/${myName}`), true);
            if (idx === correct) {
                const timeTaken = (Date.now() - startTime) / 1000;
                const speedBonus = Math.max(0, 10 - timeTaken); 
                const totalPoints = 10 + speedBonus;
                
                const myScoreRef = ref(db, `scores/${myName}`);
                get(myScoreRef).then(s => set(myScoreRef, (s.val() || 0) + totalPoints));
            }
            document.getElementById('player-input-area').innerHTML = "<p class='text-teal-500 font-bold animate-pulse'>ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…! Ø§Ù†ØªØ¸Ø± Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ...</p>";
        };
    </script>
</body>
</html>
