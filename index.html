<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --app-height: 100%;
            /* Responsive Font Sizes */
            --font-title: clamp(1.5rem, 5vw, 3rem);
            --font-body: clamp(1rem, 3vw, 1.8rem);
        }

        body { 
            font-family: 'Tajawal', sans-serif; 
            background-color: #0f172a; 
            color: #f8fafc; 
            overflow: hidden; 
            height: 100vh;
            height: -webkit-fill-available;
        }

        /* Adjusts for large TV screens */
        @media (min-width: 1024px) {
            #app { max-width: 800px !important; }
            .key-btn { height: 80px !important; font-size: 2rem !important; }
            .digit-box { width: 100px !important; height: 100px !important; font-size: 3rem !important; }
        }

        #app {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 100%;
            margin: 0 auto;
        }

        .bg-slate-card { background-color: #1e293b; }
        .btn-teal { background-color: #14b8a6; }
        .btn-purple { background-color: #a855f7; }
        .hidden { display: none !important; }
        
        /* CSS HANDS ANIMATION */
        .hand-container { 
            position: relative; 
            width: clamp(200px, 40vw, 400px); 
            height: clamp(120px, 25vw, 250px); 
            margin: 20px auto; 
            perspective: 1000px; 
        }
        .hand { 
            position: absolute; width: 50%; height: 100%; background: #fbbf24; 
            border: 4px solid #b45309; transition: transform 0.6s ease-in-out; 
            z-index: 10; display: flex; align-items: center; justify-content: center; 
        }
        .hand-left { left: 0; transform-origin: left; border-radius: 20px 0 0 20px; border-right: none; }
        .hand-right { right: 0; transform-origin: right; border-radius: 0 20px 20px 0; border-left: none; }
        .open .hand-left { transform: rotateY(-110deg); }
        .open .hand-right { transform: rotateY(110deg); }
        
        .number-reveal { 
            position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; 
            font-size: clamp(3rem, 10vw, 7rem); font-weight: 800; color: #fff; z-index: 5; 
            opacity: 0; transition: opacity 0.2s; 
        }
        .open .number-reveal { opacity: 1; }

        .pulse-bg { animation: pulseBg 1.5s infinite; }
        @keyframes pulseBg { 0%, 100% { background-color: #1e293b; } 50% { background-color: #312e81; } }

        /* KEYPAD STYLES */
        .keypad-grid { 
            display: grid; grid-template-columns: repeat(3, 1fr); 
            gap: clamp(4px, 1.5vw, 12px); width: 100%; max-width: 400px; margin: 0 auto; 
        }
        .key-btn { 
            height: clamp(50px, 12vh, 70px); 
            display: flex; align-items: center; justify-content: center; 
            background: #334155; border-radius: 12px; font-size: 1.5rem; 
            font-weight: bold; border-bottom: 4px solid #0f172a; touch-action: manipulation;
        }
        .key-btn.disabled { opacity: 0.2; pointer-events: none; }
        
        .digit-box { 
            width: clamp(50px, 15vw, 80px); height: clamp(50px, 15vw, 80px); 
            border: 2px solid #475569; border-radius: 12px; display: flex; 
            align-items: center; justify-content: center; font-size: 1.8rem; font-weight: bold; 
            background: #1e293b; transition: all 0.4s; 
        }
        .digit-correct { background: #059669 !important; }
        .digit-wrong { background: #991b1b !important; text-decoration: line-through; }
    </style>
</head>
<body>

    <div id="app" class="px-4 py-4 sm:py-8">
        <header class="flex justify-between items-center mb-4 shrink-0">
            <button onclick="goHome()" id="global-home-btn" class="hidden text-slate-400 text-sm">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
            <h1 class="font-extrabold text-teal-400 mx-auto" style="font-size: var(--font-title);">Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</h1>
        </header>
        
        <main class="flex-1 flex flex-col justify-center overflow-hidden">
            <div id="setup-screen" class="space-y-6 w-full max-w-sm mx-auto">
                <div class="bg-slate-card p-6 rounded-3xl shadow-2xl border border-slate-700">
                    <input id="player-name-input" type="text" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ..." class="w-full p-4 rounded-xl bg-slate-800 text-center text-white mb-4 border border-slate-600 outline-none text-lg">
                    <button onclick="setRole('player')" class="w-full btn-teal text-white p-5 rounded-2xl text-xl font-bold shadow-lg active:scale-95 transition-transform">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
                </div>
                <button onclick="showHostAuth()" class="w-full text-slate-500 text-sm underline text-center">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø´Ø±Ù (Host)</button>
            </div>

            <div id="host-auth" class="hidden fixed inset-0 bg-black/90 flex items-center justify-center p-6 z-50">
                <div class="bg-slate-900 p-8 rounded-3xl border border-slate-700 w-full max-w-xs text-center">
                    <h2 class="mb-4 text-white">Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…Ø´Ø±Ù</h2>
                    <input id="host-pin" type="password" placeholder="****" class="w-full p-4 rounded-xl bg-slate-800 text-center text-white mb-4 text-2xl tracking-widest">
                    <button onclick="verifyHost()" class="w-full p-3 btn-purple rounded-xl font-bold">ØªØ£ÙƒÙŠØ¯</button>
                </div>
            </div>

            <div id="section-select" class="hidden space-y-4 w-full max-w-md mx-auto z-10">
                <button onclick="chooseSection('adults')" class="w-full p-6 bg-slate-700 rounded-3xl font-bold border-b-8 border-slate-900 text-2xl hover:bg-slate-600 transition-colors">Ù‚Ø³Ù… Ø§Ù„ÙƒØ¨Ø§Ø±</button>
                <button onclick="chooseSection('children')" class="w-full p-6 bg-pink-900 rounded-3xl font-bold border-b-8 border-pink-950 text-2xl hover:bg-pink-800 transition-colors">Ù‚Ø³Ù… Ø§Ù„Ø£Ø·ÙØ§Ù„</button>
            </div>

            <div id="type-select" class="hidden space-y-4 w-full max-w-md mx-auto z-10 overflow-y-auto pr-2">
                <div class="bg-slate-800 p-4 rounded-xl flex justify-between items-center">
                    <span class="text-lg">ØªÙØ¹ÙŠÙ„ Ù…Ø¤Ù‚Øª Ø§Ù„Ø³Ø¤Ø§Ù„</span>
                    <input type="checkbox" id="timer-enabled" class="w-8 h-8 accent-teal-500" checked>
                </div>
                <div id="brain-sub-menu" class="space-y-3"></div>
                <button onclick="setupTwisters()" class="w-full p-6 bg-orange-600 rounded-3xl font-bold text-2xl shadow-xl">ØªÙ„Ø§Ø¹Ø¨ Ù„ÙØ¸ÙŠ ğŸ‘…</button>
            </div>

            <div id="memory-difficulty" class="hidden space-y-4 w-full max-w-md mx-auto z-10">
                <h2 class="text-center font-bold text-2xl mb-4">Ø§Ø®ØªØ± Ø§Ù„ØµØ¹ÙˆØ¨Ø©</h2>
                <button onclick="startMemory('easy')" class="w-full p-5 bg-green-700 rounded-2xl font-bold text-xl">Ø³Ù‡Ù„</button>
                <button onclick="startMemory('medium')" class="w-full p-5 bg-yellow-700 rounded-2xl font-bold text-xl">Ù…ØªÙˆØ³Ø·</button>
                <button onclick="startMemory('hard')" class="w-full p-5 bg-red-800 rounded-2xl font-bold text-xl">ØµØ¹Ø¨ Ø¬Ø¯Ø§Ù‹</button>
            </div>

            <div id="game-play" class="hidden flex-1 flex flex-col h-full">
                <div id="host-view" class="hidden flex flex-col h-full space-y-4">
                    <div class="bg-slate-800 p-3 rounded-2xl flex justify-between items-center shrink-0 border border-slate-700">
                        <span id="answer-counter" class="text-teal-400 font-bold">...</span>
                        <span id="host-timer-text" class="text-red-400 font-black text-xl"></span>
                    </div>

                    <div id="host-game-container" class="bg-slate-card rounded-[2rem] p-6 flex-1 flex flex-col justify-center relative overflow-hidden shadow-2xl border border-slate-700">
                        <div id="memory-visuals" class="hidden text-center">
                            <div id="hand-wrapper" class="hand-container">
                                <div class="hand hand-left"></div>
                                <div class="number-reveal" id="target-number-display">0000</div>
                                <div class="hand hand-right"></div>
                            </div>
                            <h3 id="host-status-msg" class="font-bold text-2xl mt-4">...</h3>
                        </div>

                        <div id="standard-visuals" class="text-center">
                            <div id="player-spotlight" class="hidden text-orange-400 font-bold text-xl mb-4">Ø§Ù„Ø¯ÙˆØ± Ø¹Ù„Ù‰: <span id="current-player-name" class="underline">---</span></div>
                            <h2 id="display-title" class="font-bold leading-tight" style="font-size: var(--font-body);">...</h2>
                            <div id="display-content" class="mt-6 text-2xl text-teal-200"></div>
                        </div>
                    </div>

                    <div id="host-controls" class="shrink-0 py-2">
                        <div id="twister-scoring" class="hidden grid grid-cols-5 gap-2 mb-4">
                            <button onclick="awardManual(2)" class="p-4 bg-red-900 rounded-xl font-bold">2</button>
                            <button onclick="awardManual(4)" class="p-4 bg-orange-800 rounded-xl font-bold">4</button>
                            <button onclick="awardManual(6)" class="p-4 bg-yellow-700 rounded-xl font-bold">6</button>
                            <button onclick="awardManual(8)" class="p-4 bg-green-800 rounded-xl font-bold">8</button>
                            <button onclick="awardManual(10)" class="p-4 bg-green-500 rounded-xl font-black">10</button>
                        </div>
                        <button id="action-btn" onclick="triggerNext()" class="w-full btn-purple p-6 rounded-3xl font-black text-2xl shadow-xl active:scale-95 transition-transform">Ø§Ù„ØªØ§Ù„ÙŠ</button>
                        
                        <div id="post-game-controls" class="hidden grid grid-cols-2 gap-3 mt-2">
                            <button onclick="restartSameCategory()" class="p-4 btn-teal rounded-2xl font-bold">Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
                            <button onclick="backToGameList()" class="p-4 bg-slate-700 rounded-2xl font-bold">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
                        </div>
                    </div>

                    <div id="leaderboard-ui" class="hidden bg-slate-900/80 p-4 rounded-2xl border border-teal-500/50 backdrop-blur-sm overflow-y-auto max-h-[25vh] shrink-0">
                        <div id="leaderboard-list" class="space-y-1"></div>
                    </div>
                </div>

                <div id="player-view" class="hidden flex flex-col h-full">
                    <div class="bg-slate-800 p-3 rounded-2xl flex justify-between text-sm mb-4 shrink-0 border border-slate-700">
                        <span id="p-round">Ø¬ÙˆÙ„Ø©: -</span>
                        <span id="p-status" class="text-teal-400 font-bold">Ø¬Ø§Ù‡Ø²ØŸ</span>
                        <span id="p-score" class="font-bold">0</span>
                    </div>

                    <div class="flex-1 flex flex-col justify-center">
                        <div id="player-quiz-ui" class="w-full space-y-4">
                            <div id="player-q-text" class="text-center font-bold text-xl mb-4 italic px-4">...</div>
                            <div id="player-input-area" class="px-2 space-y-3"></div>
                        </div>

                        <div id="player-memory-ui" class="hidden w-full flex flex-col items-center">
                            <div class="flex gap-2 mb-8" id="digit-boxes">
                                <div class="digit-box" data-idx="0">-</div>
                                <div class="digit-box" data-idx="1">-</div>
                                <div class="digit-box" data-idx="2">-</div>
                                <div class="digit-box" data-idx="3">-</div>
                            </div>
                        </div>
                    </div>

                    <div id="keypad-container" class="hidden pb-4 shrink-0">
                        <div class="keypad-grid">
                            <button class="key-btn disabled" onclick="pressKey('1')">1</button>
                            <button class="key-btn disabled" onclick="pressKey('2')">2</button>
                            <button class="key-btn disabled" onclick="pressKey('3')">3</button>
                            <button class="key-btn disabled" onclick="pressKey('4')">4</button>
                            <button class="key-btn disabled" onclick="pressKey('5')">5</button>
                            <button class="key-btn disabled" onclick="pressKey('6')">6</button>
                            <button class="key-btn disabled" onclick="pressKey('7')">7</button>
                            <button class="key-btn disabled" onclick="pressKey('8')">8</button>
                            <button class="key-btn disabled" onclick="pressKey('9')">9</button>
                            <button class="key-btn disabled text-red-400" onclick="pressKey('back')">âŒ«</button>
                            <button class="key-btn disabled" onclick="pressKey('0')">0</button>
                            <button class="key-btn disabled submit" id="mem-submit" onclick="submitMemory()">Ø¥Ø±Ø³Ø§Ù„</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { gameData } from './questions.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, remove, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBGwNKIykgrmewdwUZyA93DQ-LHI3rLOyw",
            authDomain: "family-games-app.firebaseapp.com",
            databaseURL: "https://family-games-app-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "family-games-app",
            storageBucket: "family-games-app.firebasestorage.app",
            messagingSenderId: "290150126558",
            appId: "1:290150126558:web:bf5a38cc8d104462d9c34f"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const liveRef = ref(db, 'live_game');
        const scoresRef = ref(db, 'scores');
        const answersRef = ref(db, 'current_answers');

        let myRole = '', myName = '', currentSection = '', currentType = '';
        let currentQuestions = [], currentIndex = -1, lastGameConfig = {};
        let playersList = [], timerInterval = null, memoryInput = "", roundStartTime = 0;

        // AUTH & SETUP
        window.goHome = () => { if(myRole === 'host') { remove(liveRef); remove(scoresRef); } location.reload(); };
        window.showHostAuth = () => document.getElementById('host-auth').classList.remove('hidden');
        window.verifyHost = () => { if(document.getElementById('host-pin').value === '1234') { document.getElementById('host-auth').classList.add('hidden'); setRole('host'); } else { alert("Ø®Ø·Ø£!"); } };

        window.setRole = (role) => {
            myRole = role;
            if (role === 'player') {
                myName = document.getElementById('player-name-input').value.trim();
                if (!myName) return;
                set(ref(db, `scores/${myName}`), 0);
            }
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('global-home-btn').classList.remove('hidden');
            if (role === 'host') {
                remove(liveRef); remove(answersRef);
                document.getElementById('section-select').classList.remove('hidden');
                onValue(scoresRef, (snap) => { if(snap.val()) playersList = Object.keys(snap.val()); });
            } else {
                document.getElementById('game-play').classList.remove('hidden');
                document.getElementById('player-view').classList.remove('hidden');
                listenForGame();
            }
        };

        window.chooseSection = (s) => {
            currentSection = s;
            document.getElementById('section-select').classList.add('hidden');
            document.getElementById('type-select').classList.remove('hidden');
            const menu = document.getElementById('brain-sub-menu');
            menu.innerHTML = (s === 'adults') ? 
                `<button onclick="setupQuestions('culture')" class="w-full p-5 bg-indigo-600 rounded-3xl font-bold mb-3 text-xl">Ø«Ù‚Ø§ÙØ© Ø¹Ø§Ù…Ø©</button>
                 <button onclick="setupQuestions('islamic')" class="w-full p-5 bg-indigo-600 rounded-3xl font-bold mb-3 text-xl">Ø£Ø³Ø¦Ù„Ø© Ø¥Ø³Ù„Ø§Ù…ÙŠØ©</button>
                 <button onclick="showMemoryDiff()" class="w-full p-5 bg-indigo-600 rounded-3xl font-bold mb-3 text-xl">Ù„Ø¹Ø¨Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø© ğŸ§ </button>` :
                `<button onclick="setupQuestions('brain')" class="w-full p-5 bg-indigo-600 rounded-3xl font-bold text-xl">Ø°ÙƒØ§Ø¡ Ø§Ù„Ø£Ø·ÙØ§Ù„</button>`;
        };

        window.showMemoryDiff = () => {
            document.getElementById('type-select').classList.add('hidden');
            document.getElementById('memory-difficulty').classList.remove('hidden');
        };

        // GAME LOADING
        window.setupQuestions = (type) => {
            currentType = 'brain'; currentIndex = -1;
            lastGameConfig = { section: currentSection, type: 'brain', pool: type };
            currentQuestions = shuffleArray(gameData[currentSection][type]).slice(0, 7);
            showHostUI();
        };

        window.setupTwisters = () => {
            currentType = 'twister'; currentIndex = -1;
            lastGameConfig = { section: 'adults', type: 'twister' };
            currentQuestions = shuffleArray(gameData.adults.twisters).slice(0, 5);
            showHostUI();
        };

        window.startMemory = (diff) => {
            currentType = 'memory'; currentIndex = -1;
            lastGameConfig = { type: 'memory', diff: diff };
            document.getElementById('memory-difficulty').classList.add('hidden');
            currentQuestions = Array.from({length: 5}, () => Math.floor(1000 + Math.random() * 9000).toString());
            showHostUI();
        };

        function showHostUI() {
            document.getElementById('type-select').classList.add('hidden');
            document.getElementById('game-play').classList.remove('hidden');
            document.getElementById('host-view').classList.remove('hidden');
            document.getElementById('display-title').innerText = "Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©";
            document.getElementById('display-content').innerText = "Ø§Ø³ØªØ¹Ø¯ÙˆØ§ Ù„Ù„Ø¨Ø¯Ø¡!";
        }

        // GAME ENGINE
        window.triggerNext = () => {
            currentIndex++;
            clearInterval(timerInterval);
            remove(answersRef);
            document.getElementById('leaderboard-ui').classList.add('hidden');

            if (currentIndex >= currentQuestions.length) return announceWinner();

            const item = currentQuestions[currentIndex];
            if (currentType === 'memory') {
                handleMemoryRound(item);
            } else {
                let pSpot = (currentType === 'twister') ? (playersList[currentIndex % playersList.length] || "Ø§Ù„Ù…ØªØ·ÙˆØ¹") : "Ø§Ù„Ø¬Ù…ÙŠØ¹";
                set(liveRef, { type: currentType, content: item, round: currentIndex + 1, status: 'playing', activePlayer: pSpot, startTime: Date.now() });
                renderHostStandard(item, pSpot);
                if (document.getElementById('timer-enabled').checked) startTimer(15);
            }
        };

        async function handleMemoryRound(target) {
            const diff = lastGameConfig.diff;
            const config = { easy: [2500, 10], medium: [1800, 8], hard: [1100, 5] }[diff];
            document.getElementById('standard-visuals').classList.add('hidden');
            document.getElementById('memory-visuals').classList.remove('hidden');
            document.getElementById('target-number-display').innerText = target;
            
            let cd = 3;
            set(liveRef, { type: 'memory', status: 'countdown', round: currentIndex + 1 });
            const countInt = setInterval(() => {
                document.getElementById('host-status-msg').innerText = `Ø§Ù„Ø¬ÙˆÙ„Ø© ØªØ¨Ø¯Ø£ ÙÙŠ... ${cd}`;
                if(cd-- === 0) {
                    clearInterval(countInt);
                    document.getElementById('hand-wrapper').classList.add('open');
                    document.getElementById('host-game-container').classList.add('pulse-bg');
                    set(liveRef, { type: 'memory', status: 'reveal', target: target, duration: config[0] });
                    setTimeout(() => {
                        document.getElementById('hand-wrapper').classList.remove('open');
                        document.getElementById('host-game-container').classList.remove('pulse-bg');
                        document.getElementById('host-status-msg').innerText = "Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ† ÙŠÙƒØªØ¨ÙˆÙ†...";
                        set(liveRef, { type: 'memory', status: 'input', target: target, duration: config[1], startTime: Date.now() });
                        startTimer(config[1], true);
                        listenForAnswers();
                    }, config[0]);
                }
            }, 1000);
        }

        function startTimer(sec, isMemory = false) {
            let remain = sec;
            timerInterval = setInterval(() => {
                document.getElementById('host-timer-text').innerText = remain + "Ø«";
                if (remain-- <= 0) {
                    clearInterval(timerInterval);
                    if (isMemory) showMemoryResults();
                    else showMidGameLeaderboard();
                    if (currentType === 'twister') document.getElementById('twister-scoring').classList.remove('hidden');
                }
            }, 1000);
        }

        async function showMemoryResults() {
            set(liveRef, { status: 'scoring' });
            const target = currentQuestions[currentIndex];
            const ansSnap = await get(answersRef);
            const answers = ansSnap.val() || {};
            let displayHtml = `<div class='space-y-2 text-lg'>`;
            for(let pName of playersList) {
                const pData = answers[pName] || { val: "----", time: 99999 };
                let score = 0, coloredDigits = "";
                for(let i=0; i<4; i++) {
                    const char = pData.val[i] || "-";
                    if(char === target[i]) { score += 2; coloredDigits += `<span class="text-green-500 mx-0.5">${char}</span>`; }
                    else { coloredDigits += `<span class="text-red-500 line-through mx-0.5">${char}</span>`; }
                }
                if(score === 8) { score = 10; if(pData.time < 3000) score += 5; }
                const curS = await get(ref(db, `scores/${pName}`));
                set(ref(db, `scores/${pName}`), (curS.val() || 0) + score);
                displayHtml += `<div class="flex justify-between border-b border-slate-700"><span>${pName}</span><span>${coloredDigits} (+${score})</span></div>`;
            }
            document.getElementById('display-content').innerHTML = displayHtml;
            showMidGameLeaderboard();
        }

        async function showMidGameLeaderboard() {
            const snap = await get(scoresRef);
            const scores = snap.val() || {};
            const sorted = Object.entries(scores).sort((a,b) => b[1]-a[1]);
            document.getElementById('leaderboard-list').innerHTML = sorted.map(([n,v]) => `<div class='flex justify-between p-1'><span>${n}</span><span>${Math.round(v)}</span></div>`).join('');
            document.getElementById('leaderboard-ui').classList.remove('hidden');
            set(liveRef, { status: 'scoring' });
        }

        function renderHostStandard(item, pSpot) {
            const title = document.getElementById('display-title');
            const content = document.getElementById('display-content');
            if (currentType === 'brain') {
                title.innerText = item.q;
                content.innerHTML = item.options.map(o => `<div class='p-3 bg-slate-800 rounded-2xl mb-2 text-xl'>${o}</div>`).join('');
            } else {
                title.innerText = "ÙƒØ±Ø± Ø¨Ø³Ø±Ø¹Ø© 5 Ù…Ø±Ø§Øª:";
                content.innerHTML = `<p class='text-4xl text-teal-400 font-black'>${item}</p>`;
                document.getElementById('current-player-name').innerText = pSpot;
                document.getElementById('player-spotlight').classList.remove('hidden');
            }
        }

        function listenForAnswers() {
            onValue(answersRef, (snap) => {
                const count = snap.val() ? Object.keys(snap.val()).length : 0;
                document.getElementById('answer-counter').innerText = `Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª: ${count} / ${playersList.length}`;
            });
        }

        async function announceWinner() {
            const snap = await get(scoresRef);
            const scores = snap.val() || {};
            const sorted = Object.entries(scores).sort((a,b) => b[1]-a[1]);
            const winner = sorted[0] ? sorted[0][0] : "---";
            set(liveRef, { status: 'finished', winner: winner });
            document.getElementById('display-title').innerText = "ğŸ† Ø§Ù„ÙØ§Ø¦Ø² Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ğŸ†";
            document.getElementById('display-content').innerHTML = `<h1 class='text-6xl text-yellow-400 font-black'>${winner}</h1>`;
            document.getElementById('post-game-controls').classList.remove('hidden');
            document.getElementById('action-btn').classList.add('hidden');
            confetti({ particleCount: 300, spread: 100, origin: { y: 0.6 } });
        }

        // PLAYER ENGINE
        function listenForGame() {
            onValue(liveRef, (snap) => {
                const data = snap.val(); if(!data) return;
                document.getElementById('p-round').innerText = `Ø¬ÙˆÙ„Ø©: ${data.round || 1}`;
                get(ref(db, `scores/${myName}`)).then(s => document.getElementById('p-score').innerText = `Ù†Ù‚Ø§Ø·ÙŠ: ${Math.round(s.val() || 0)}`);

                if(data.status === 'finished') {
                    confetti();
                    document.getElementById('player-q-text').innerText = "Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©!";
                    document.getElementById('player-input-area').innerHTML = `<div class='text-yellow-400 text-3xl font-bold'>Ø§Ù„ÙØ§Ø¦Ø² Ù‡Ùˆ: ${data.winner}</div>`;
                    return;
                }

                if(data.type === 'memory') {
                    document.getElementById('keypad-container').classList.remove('hidden');
                    document.getElementById('player-memory-ui').classList.remove('hidden');
                    document.getElementById('player-quiz-ui').classList.add('hidden');
                    handlePlayerMemory(data);
                } else {
                    document.getElementById('keypad-container').classList.add('hidden');
                    document.getElementById('player-memory-ui').classList.add('hidden');
                    document.getElementById('player-quiz-ui').classList.remove('hidden');
                    handlePlayerStandard(data);
                }
            });
        }

        function handlePlayerMemory(data) {
            if(data.status === 'input') {
                document.getElementById('p-status').innerText = "Ø§ÙƒØªØ¨ Ø§Ù„Ø¢Ù†!";
                setKeypadState(true);
                if(!roundStartTime) roundStartTime = Date.now();
            } else {
                document.getElementById('p-status').innerText = (data.status === 'scoring') ? "Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª" : "Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø´Ø§Ø´Ø©";
                setKeypadState(false);
                if(data.status === 'countdown') { resetMemoryUI(); roundStartTime = 0; }
            }
        }

        function setKeypadState(enabled) {
            document.querySelectorAll('.key-btn').forEach(b => b.classList.toggle('disabled', !enabled));
            document.getElementById('mem-submit').classList.add('disabled');
        }

        window.pressKey = (key) => {
            if(key === 'back') memoryInput = memoryInput.slice(0, -1);
            else if(memoryInput.length < 4) memoryInput += key;
            const boxes = document.querySelectorAll('#digit-boxes .digit-box');
            boxes.forEach((box, i) => box.innerText = memoryInput[i] || "-");
            document.getElementById('mem-submit').classList.toggle('disabled', memoryInput.length < 4);
        };

        window.submitMemory = () => {
            set(ref(db, `current_answers/${myName}`), { val: memoryInput, time: Date.now() - roundStartTime });
            setKeypadState(false);
            document.getElementById('p-status').innerText = "ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ âœ“";
        };

        function resetMemoryUI() {
            memoryInput = "";
            document.querySelectorAll('.digit-box').forEach(b => { b.innerText = "-"; b.className = "digit-box"; });
        }

        function handlePlayerStandard(data) {
            if(data.status === 'scoring') {
                document.getElementById('p-status').innerText = "Ø§Ù†ØªØ¸Ø±...";
                document.getElementById('player-input-area').innerHTML = "<div class='text-center text-teal-400'>Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©</div>";
                return;
            }
            if(data.type === 'brain') {
                document.getElementById('p-status').innerText = "Ø£Ø¬Ø¨ Ø§Ù„Ø¢Ù†!";
                document.getElementById('player-q-text').innerText = data.content.q;
                document.getElementById('player-input-area').innerHTML = data.content.options.map((o, i) => 
                    `<button onclick="submitQuiz(${i}, ${data.content.correct}, ${data.startTime})" class="p-5 btn-teal rounded-2xl font-bold block w-full text-xl shadow-md active:scale-95">${o}</button>`
                ).join('');
            } else {
                document.getElementById('p-status').innerText = (data.activePlayer === myName) ? "Ø¯ÙˆØ±Ùƒ Ø§Ù„Ø¢Ù†!" : "Ø§Ø³ØªÙ…Ø¹ Ù„Ù„Ù…ØªØ­Ø¯Ø«";
                document.getElementById('player-q-text').innerText = (data.activePlayer === myName) ? data.content : "---";
                document.getElementById('player-input-area').innerHTML = "";
            }
        }

        window.submitQuiz = (idx, correct, start) => {
            set(ref(db, `current_answers/${myName}`), true);
            if(idx === correct) {
                const pts = 10 + Math.max(0, 10 - (Date.now() - start)/1000);
                get(ref(db, `scores/${myName}`)).then(s => set(ref(db, `scores/${myName}`), (s.val() || 0) + pts));
            }
            document.getElementById('player-input-area').innerHTML = "<div class='text-center text-teal-400 text-2xl font-bold'>ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ âœ“</div>";
        };

        window.restartSameCategory = () => {
            playersList.forEach(p => set(ref(db, `scores/${p}`), 0));
            if(lastGameConfig.type === 'memory') startMemory(lastGameConfig.diff);
            else if(lastGameConfig.type === 'brain') setupQuestions(lastGameConfig.pool);
            else setupTwisters();
        };

        window.backToGameList = () => {
            playersList.forEach(p => set(ref(db, `scores/${p}`), 0));
            remove(liveRef);
            document.getElementById('host-view').classList.add('hidden');
            document.getElementById('type-select').classList.remove('hidden');
        };

        function shuffleArray(arr) { return arr.sort(() => Math.random() - 0.5); }
        window.awardManual = (pts) => {
            const name = document.getElementById('current-player-name').innerText;
            get(ref(db, `scores/${name}`)).then(s => set(ref(db, `scores/${name}`), (s.val() || 0) + pts));
            document.getElementById('twister-scoring').classList.add('hidden');
        };
    </script>
</body>
</html>
