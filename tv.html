<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>شاشة العرض - ألعاب العائلة</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { 
            height: 100%; 
            height: -webkit-fill-available;
            background-color: #0f172a; 
            color: #f8fafc; 
            font-family: 'Tajawal', sans-serif;
            overflow: hidden;
        }
        body { padding: 5vh 5vw; display: flex; flex-direction: column; }
        .hidden { display: none !important; }
        .bg-slate-card { background-color: #1e293b; }
        
        #tv-root { display: flex; flex-direction: column; gap: 2vh; height: 90vh; width: 100%; }
        
        #tv-top-bar {
            background: #1e293b; padding: 2vh 3vw; border-radius: 2vh;
            display: flex; justify-content: space-between; align-items: center;
            font-size: 3vh; border: 0.5vh solid #334155; flex-shrink: 0; min-height: 8vh;
        }
        
        #tv-main-container {
            flex: 1; background: #1e293b; border-radius: 3vh; border: 0.8vh solid #475569;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 4vh; position: relative; overflow: hidden; min-height: 0;
        }
        
        #display-title { font-size: 6vh; line-height: 1.3; margin-bottom: 3vh; color: #14b8a6; font-weight: 900; text-align: center; max-width: 100%; word-wrap: break-word; }
        #display-content { font-size: 4.5vh; color: #cbd5e1; font-weight: 700; line-height: 1.4; width: 100%; overflow: hidden; }
        #display-content div { padding: 2vh; margin: 1.5vh 0; background: #334155; border-radius: 2vh; border: 0.3vh solid #475569; font-size: 3.5vh; line-height: 1.3; }
        #display-content h1 { font-size: 10vh; color: #fbbf24; line-height: 1.1; }
        
        .hand-container { position: relative; width: 60vh; height: 35vh; max-width: 90%; margin: 2vh auto; perspective: 2000px; flex-shrink: 0; }
        .hand { position: absolute; width: 50%; height: 100%; background: #fbbf24; border: 1vh solid #b45309; transition: transform 0.6s ease-in-out; z-index: 10; }
        .hand-left { left: 0; transform-origin: left; border-radius: 4vh 0 0 4vh; }
        .hand-right { right: 0; transform-origin: right; border-radius: 0 4vh 4vh 0; }
        .open .hand-left { transform: rotateY(-110deg); }
        .open .hand-right { transform: rotateY(110deg); }
        .number-reveal { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-size: 15vh; font-weight: 900; color: #fff; z-index: 5; opacity: 0; transition: opacity 0.2s; direction: ltr; }
        .open .number-reveal { opacity: 1; }
        
        #tv-score-container { flex: 1; background: #0f172a; border-radius: 3vh; padding: 3vh; border: 0.8vh solid #f59e0b; overflow-y: auto; display: flex; flex-direction: column; }
        .score-row { display: flex; justify-content: space-between; padding: 2vh; border-bottom: 0.4vh solid #334155; font-size: 4vh; align-items: center; flex-shrink: 0; }
        .score-row:last-child { border: none; }
        
        #welcome-screen { text-align: center; }
        #welcome-screen h1 { font-size: 8vh; color: #14b8a6; margin-bottom: 3vh; }
        #welcome-screen p { font-size: 3.5vh; color: #94a3b8; }
        #error-message { color: #ef4444; font-size: 3vh; text-align: center; margin-top: 2vh; }
        
        @media (max-height: 500px) {
            #display-title { font-size: 5vh; }
            #display-content { font-size: 3.5vh; }
            .hand-container { height: 25vh; width: 45vh; }
            .number-reveal { font-size: 10vh; }
        }
        @media (min-aspect-ratio: 21/9) {
            #tv-main-container { max-width: 80%; margin: 0 auto; }
        }
    </style>
</head>
<body>

    <div id="tv-root">
        <div id="tv-top-bar" class="hidden">
            <span id="conn-status" style="color: #64748b;">● متصل</span>
            <span id="tv-timer-display"></span>
        </div>

        <div id="tv-main-container" class="bg-slate-card">
            <div id="welcome-screen">
                <h1>بانتظار المضيف...</h1>
                <p>Connected to Firebase</p>
                <div id="error-message" class="hidden"></div>
            </div>
        </div>

        <div id="tv-score-container" class="hidden"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        try {
            const firebaseConfig = {
                apiKey: "AIzaSyBGwNKIykgrmewdwUZyA93DQ-LHI3rLOyw",
                authDomain: "family-games-app.firebaseapp.com",
                databaseURL: "https://family-games-app-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "family-games-app",
                storageBucket: "family-games-app.firebasestorage.app",
                messagingSenderId: "290150126558",
                appId: "1:290150126558:web:bf5a38cc8d104462d9c34f"
            };
            
            const app = initializeApp(firebaseConfig);
            const db = getDatabase(app);
            const mirrorRef = ref(db, 'tv_mirror');
            let lastUpdate = Date.now();
            
            // Connection monitor
            setInterval(() => {
                if (Date.now() - lastUpdate > 10000) {
                    document.getElementById('conn-status').style.color = '#ef4444';
                    document.getElementById('conn-status').innerText = '● انقطع الاتصال';
                }
            }, 5000);

            onValue(mirrorRef, (snap) => {
                try {
                    const data = snap.val();
                    lastUpdate = Date.now();
                    document.getElementById('conn-status').style.color = '#10b981';
                    document.getElementById('conn-status').innerText = '● متصل';
                    
                    if(!data) return;

                    // Confetti with performance fix
                    if (data.trigger_confetti) {
                        const lastFired = window.lastConfettiTime || 0;
                        if (data.trigger_confetti > lastFired) {
                            // Detect TV/large screen and reduce particles
                            const isTV = window.innerWidth > 1024 || window.innerHeight > 800;
                            
                            confetti({ 
                                particleCount: isTV ? 80 : 300,
                                spread: 100,
                                gravity: 1.2,
                                ticks: 80,
                                decay: 0.8,
                                origin: { y: 0.6 },
                                disableForReducedMotion: true
                            });
                            window.lastConfettiTime = data.trigger_confetti;
                        }
                    }

                    const main = document.getElementById('tv-main-container');
                    const scores = document.getElementById('tv-score-container');
                    const top = document.getElementById('tv-top-bar');

                    if(!data.mainHTML || data.mainHTML.trim() === "") return;

                    top.classList.remove('hidden');

                    if(data.scoreVisible) {
                        main.classList.add('hidden');
                        scores.classList.remove('hidden');
                        scores.innerHTML = data.scoreHTML || '';
                    } else {
                        scores.classList.add('hidden');
                        main.classList.remove('hidden');
                        main.innerHTML = data.mainHTML;
                        main.className = data.mainClasses + " flex-1 rounded-[4rem] border-8 shadow-2xl flex flex-col justify-center text-center p-12 relative overflow-hidden bg-slate-card";
                        
                        // Force font size recalculation
                        const title = main.querySelector('#display-title');
                        const content = main.querySelector('#display-content');
                        if(title) title.style.fontSize = '6vh';
                        if(content) content.style.fontSize = '4.5vh';
                    }
                } catch (err) {
                    console.error("Error in onValue:", err);
                    document.getElementById('error-message').textContent = "خطأ في تحميل البيانات: " + err.message;
                    document.getElementById('error-message').classList.remove('hidden');
                }
            }, (error) => {
                console.error("Firebase error:", error);
                document.getElementById('error-message').textContent = "خطأ في الاتصال: " + error.message;
                document.getElementById('error-message').classList.remove('hidden');
            });
            
        } catch (initErr) {
            console.error("Init error:", initErr);
            document.getElementById('welcome-screen').innerHTML += `<div style="color:red; font-size:2vh; margin-top:2vh;">خطأ في التحميل: ${initErr.message}</div>`;
        }

        window.addEventListener('resize', () => {
            document.body.style.display = 'none';
            document.body.offsetHeight;
            document.body.style.display = 'flex';
        });
    </script>
</body>
</html>
